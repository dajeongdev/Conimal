<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="community">
	<!-- 인기 태그 리스트 -->
	<select id="getHitTag" parameterType="kr.com.conimal.model.dto.CommunityDto" resultType="kr.com.conimal.model.dto.CommunityDto">
		
	</select>
	
	
	<!-- 전체 글 목록 / 제목, 태그, 댓글 수, 작성자, 작성일 -->
	<select id="getCommunityList" parameterType="HashMap" resultType="kr.com.conimal.model.dto.CommunityDto">
		select SQL_CALC_FOUND_ROWS * from community inner user 
		on community.user_idx = user.user_idx 
		order by community.community_idx desc
	</select>
	<select id="getTotal" resultType="int">
		select FOUND_ROWS()
	</select>
	<select id="fileList" resultType="kr.com.conimal.model.dto.CommunityFileDto">
		select * from community inner join community_file where community.community_idx = community_file.community_idx order by community.community_idx desc
	</select>
	

	<!-- 글 작성 / 제목, 내용, 태그, 이미지(미리보기) -->
	<insert id="writeCommunity" parameterType="kr.com.conimal.model.dto.CommunityDto">
		insert into community (community_idx, user_idx, title, content, hit, reg_date, update_date, show_yn, del_yn) 
		values (#{community_idx}, ${user_idx}, ${title}, ${content}, 0, ${reg_date}, null, 'Y', 'N')
		<selectKey keyProperty="community_idx" resultType="int">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert> 
	<insert id="writeCommunityFile" parameterType="kr.com.conimal.model.dto.CommunityFileDto">
		insert into community_file (community_file_idx, community_idx, file_naem, file_path, file_size, del_yn) 
		values(${community_file_idx}, ${community_idx}, ${file_name}, ${file_path}, ${file_size}, 'N')
	</insert>
	
	<!-- 댓글 작성 -->
	<insert id="writeComment" parameterType="kr.com.conimal.model.dto.CommentDto">
		insert into comment (comment_idx, community_idx, user_idx, content, parent_comment_idx, depth, reg_date, del_yn) 
		values (${comment_idx}, #{community_idx}, #{user_idx}, #{content}, 0, 0, ${reg_date}, 'N')
	</insert>


	<!-- 글 보기 / 제목, 작성자, 작성일, 태그, 내용, 이미지 -->
	<select id="readCommunity" resultType="kr.com.conimal.model.dto.CommunityDto">
		select * from community where del_yn = 'N' and community_idx = ${community_idx}
	</select>
	<select id="readFile" resultType="kr.com.conimal.model.command.CommunityFileCommand">
		select * from community inner join community_file 
		on community.community_idx = community_file.community_idx 
		where community.del_yn = 'N' and community_file.community_idx = ${community_idx}
	</select>
	
	<!-- 댓글 보기 / 작성자, 작성일, 내용 (+답글) -->
	<select id="readComment" parameterType="int" resultType="kr.com.conimal.model.dto.CommentDto">
		select * from comment inner join user 
		on comment.user_idx = user.user_idx 
		where comment.community_idx = ${community_idx}
	</select>
	<select id="readCommentIdx" parameterType="int" resultType="kr.com.conimal.model.dto.CommentDto">
		select * from comment inner join user 
		on comment.user_idx = user.user_idx 
		where comment.community_idx = ${community_idx}
	</select>
	
	<!-- 조회수 증가 -->
	<update id="hitCount" parameterType="kr.com.conimal.model.dto.CommunityDto">
		update community set hit = hit + 1 where community_idx = ${community_idx}
	</update>
	
	
	<!-- 글 수정 -->
	<update id="editCommunity" parameterType="kr.com.conimal.model.dto.CommunityDto">
		update community 
		<set>
			<if test="title != null">title = ${title},</if> 
			<if test="content != null">content = ${content}</if> 
		</set>
		<where>community_idx = ${community_idx}</where>
	</update>
	<!-- 파일 수정 -->
	<!-- 댓글 수정 -->
	<update id="editComment" parameterType="kr.com.conimal.model.dto.CommentDto">
		update comment 
		<set><if test="content != null">content = ${content}</if></set>
		<where>comment_idx = ${comment_idx}</where>
	</update>
	
	
	<!-- 글 삭제 -->
	<update id="deleteCommunity" parameterType="kr.com.conimal.model.dto.CommunityDto">
		update community 
		<set>del_yn = 'Y'</set> 
		<where>community_idx = ${community_idx}</where>
	</update>
	<!-- 댓글 삭제 -->
	<update id="deleteComment" parameterType="kr.com.conimal.model.dto.CommentDto">
		update comment 
		<set>del_yn = 'Y'</set>
		<where>comment_idx = ${comment_idx}</where>
	</update>
	
	
	<!-- 좋아요 수 증가 -->
	
	 
	<!-- 검색 / 제목, 태그, 작성자, 작성일 -->
	
	
	<!-- 10개씩 보기 -->
	
	
	<!-- 페이징 -->
	
	
</mapper>